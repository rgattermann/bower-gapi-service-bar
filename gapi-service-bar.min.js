/*global angular,console*/
(function () {
    'use strict';

    // Module dependencies injection
    angular.module('gapiServiceBar', [ 'aruba.js' ]);

}());

/*global angular */
(function () {
    'use strict';

    angular.module('gapiServiceBar').config([ '$httpProvider', function ($httpProvider) {

        // Interceptor to add token on every Header Request
        $httpProvider.interceptors.push('gapiServiceBarRequestInterceptor');

    }]);

}());
/*global angular, console, $ */
(function () {
    "use strict";

    function GapiServiceBarController($scope, $rootScope, gapiServiceBarFactory) {

        /* $scope Functions */
        $scope.userPanel = function () {
            console.log('UserPanel');
        };

        $scope.userSettings = function () {
            console.log('UserSettings');
        };

        $scope.userHelp = function () {
            console.log('userHelp');
        };

        $scope.openTicket = function () {
            console.log('openTicket');
        };

        $scope.logout = function () {
            gapiServiceBarFactory.logout();
        };

        $rootScope.$on('GAPI-LOGOUT', function () {
            console.log('GAPI-SERVICE-BAR (-.-) LOGOUT');
        });

        (function () {

            // If the user is not logged will be redirected to accounts
            gapiServiceBarFactory.validateUser().then(function () {

                // Service Bar Title
                $scope.companyName = gapiServiceBarFactory.getCompanyName();

                // Service Bar Application Name
                $scope.currentApplicationName = gapiServiceBarFactory.getCurrentApplication();

                // Service Bar User
                $scope.user = gapiServiceBarFactory.getUser();

                // Service Bar Applications
                $scope.applications = gapiServiceBarFactory.getApplications();

                // Service Bar Notifications
                $scope.notifications = gapiServiceBarFactory.getNotifications();

                // Service Bar Messages
                $scope.messages = gapiServiceBarFactory.getMessages();
            });

        }());

    }

    GapiServiceBarController.$inject = [ '$scope', '$rootScope', 'gapiServiceBarFactory' ];

    angular.module('gapiServiceBar').controller('GapiServiceBarController', GapiServiceBarController);

}());

/*global angular, console, document, $*/

angular.module('gapiServiceBar').directive('gapiServiceBar', function () {
    "use strict";

    return {
        restrict: 'E',
        templateUrl: '../vendor/gapi-service-bar/gapi-service-bar.html',
        controller: 'GapiServiceBarController',

        link: function () {

            (function () {

                // Add slidedown animation to dropdown
                $('.dropdown').on('show.bs.dropdown', function () {
                    $(this).find('.dropdown-menu').first().stop(true, true).slideDown();
                });

                // Add slideup animation to dropdown
                $('.dropdown').on('hide.bs.dropdown', function () {
                    $(this).find('.dropdown-menu').first().stop(true, true).slideUp();
                });

            }());

        }
    };

});

/*global angular, console, FormData, window*/
/*jslint todo: true */

(function () {
    "use strict";

    function GapiServiceBarFactory($http, $q, $window, $rootScope, core) {

        var factory = {

            validateUser: function () {

                // Creating Promise
                var tokenDefer = $q.defer(),
                    token;

                // Checking if it comes from accounts with querystring token
                if (window.location.search.split('=')[1]) {
                    // Will set token to SessionStorage
                    this.setToken(window.location.search.split('=')[1]);
                } else {

                    // If there's no token will redirect to accounts to get a new one
                    token = this.getToken();
                    if (!token) {
                        $window.location.href = this.getAccountsUrl() + '?callbackurl=' + window.location.href;
                        tokenDefer.reject();
                    }
                }

                // Validating Token against Core Server
                this.validateToken(function (err, data) {

                    if (err || !data.result) {
                        tokenDefer.reject(err || 'No Data');
                    }

                    // Setting User Data
                    $window.localStorage.setItem('GAPI-USER', JSON.stringify(data.result));

                    // Resolving Promise
                    tokenDefer.resolve();
                });

                return tokenDefer.promise;
            },

            validateToken: function (cb) {
                $http.get(core.getAccountsCoreUrl() + 'credentials/me')
                    .success(function (data) {
                        cb(null, data);
                    })
                    .error(function (err) {
                        console.log('[ERROR - validateToken]: ', err);
                        cb(err, null);
                    });
            },

            setToken: function (token) {
                $window.localStorage.setItem('GAPI-TOKEN', token);
            },

            getToken: function () {
                return $window.localStorage.getItem('GAPI-TOKEN');
            },

            logout: function () {

                $http.get(core.getAccountsCoreUrl() + 'credentials/_logout/')
                    .success(function (data) {
                        // Remove User
                        $window.localStorage.removeItem('GAPI-USER');

                        // Remove Token
                        $window.sessionStorage.removeItem('GAPI-TOKEN');

                        // Promise Resolve
                        $rootScope.$broadcast('GAPI-LOGOUT', data);
                    })
                    .error(function (err) {
                        // Promise Reject
                        $rootScope.$broadcast('GAPI-LOGOUT', err);
                    });

            },

            getUser: function () {
                var localGapiUser = JSON.parse($window.localStorage.getItem('GAPI-USER'));
                return localGapiUser.user;
            },

            getCompanyName: function () {
                return 'Cliente';
            },

            getApplications: function () {
                var localGapiUser = JSON.parse($window.localStorage.getItem('GAPI-USER'));
                return localGapiUser.applications;
            },

            getNotifications: function () {
                // TODO: Implement Websockets
                return [{"aplicacao": "Integra", "description": "Notificação de Teste", "timespan": "Agora pouco"}];
            },

            getMessages: function () {
                return [];
            },

            getCurrentApplication: function () {
                var currentApplication = core.getApplicationName();
                return currentApplication + ' | ';
            },

            getAccountsUrl: function () {
                return core.getAccountsUrl();
            }

        };

        return factory;

    }

    GapiServiceBarFactory.$inject = [ '$http', '$q', '$window', '$rootScope', 'coreApiService' ];

    angular.module('gapiServiceBar').factory('gapiServiceBarFactory', GapiServiceBarFactory);

}());

/*global angular, console*/
(function () {
    "use strict";

    function GapiServiceBarRequestInterceptor($q, $window) {

        return {

            // On request success
            request: function (config) {
                // Add Token info to every request
                config.headers['X-Session-Token'] = $window.localStorage.getItem('GAPI-TOKEN');

                return config;
            },

            // On request error
            requestError: function (reason) {
                // Return the promise error reason.
                return $q.reject(reason);
            },

            // On response success
            response: function (response) {
                // Return the response or promise.
                return response || $q.when(response);
            },

            // On response error
            responseError: function (reason) {
                // Return the promise error reason.
                return $q.reject(reason);
            }

        };
    }

    GapiServiceBarRequestInterceptor.$inject = [ '$q', '$window' ];

    angular.module('gapiServiceBar').factory('gapiServiceBarRequestInterceptor', GapiServiceBarRequestInterceptor);

}());

//# sourceMappingURL=gapi-service-bar.min.js.map