/*global angular,console*/
(function () {
    'use strict';

    // Module dependencies injection
    angular.module('gapiServiceBar', [ 'aruba.js', 'ngMaterial' ]).config(function ($mdThemingProvider) {
        $mdThemingProvider.theme('default').primaryPalette('blue-gray');

        var gapiBlue = $mdThemingProvider.extendPalette('blue', { '500': '2F3B5C'});

        $mdThemingProvider.definePalette('gapiBlue', gapiBlue);
        $mdThemingProvider.theme('default').primaryPalette('gapiBlue');
    });

}());

/*global angular */
(function () {
    'use strict';

    angular.module('gapiServiceBar').config([ '$httpProvider', function ($httpProvider) {

        // Interceptor to add token on every Header Request
        $httpProvider.interceptors.push('gapiServiceBarRequestInterceptor');

    }]);

}());

/*global angular, console, $ */
(function () {
    "use strict";

    function GapiServiceBarController($scope, $rootScope, gapiServiceBarFactory) {

        /* $scope Functions */
        $scope.userPanel = function () {
            console.log('UserPanel');
        };

        $scope.userSettings = function () {
            console.log('UserSettings');
        };

        $scope.userHelp = function () {
            console.log('userHelp');
        };

        $scope.openTicket = function () {
            console.log('openTicket');
        };

        $scope.logout = function () {
            gapiServiceBarFactory.logout();
        };

        $scope.redirect = function (url) {
            gapiServiceBarFactory.redirect(url);
        };

        $rootScope.$on('GAPI-LOGOUT', function () {
            console.log('GAPI-SERVICE-BAR (-.-) LOGOUT');
        });

        (function () {

            // If the user is not logged will be redirected to accounts
            gapiServiceBarFactory.validateUser().then(function () {

                // Service Bar Title
                $scope.companyName = gapiServiceBarFactory.getCompanyName();

                // Service Bar Application Name
                $scope.currentApplicationName = gapiServiceBarFactory.getCurrentApplication();

                // Service Bar User
                $scope.user = gapiServiceBarFactory.getUser();

                // Service Bar Applications
                $scope.applications = gapiServiceBarFactory.getApplications();

                // Service Bar Notifications
                $scope.notifications = gapiServiceBarFactory.getNotifications();

                // Service Bar Messages
                $scope.messages = gapiServiceBarFactory.getMessages();
            });

        }());

    }

    GapiServiceBarController.$inject = [ '$scope', '$rootScope', 'gapiServiceBarFactory' ];

    angular.module('gapiServiceBar').controller('GapiServiceBarController', GapiServiceBarController);

}());

/*global angular, console, document, $*/

function GapiServiceBarDirective() {
    "use strict";

    return {
        restrict: 'E',
        templateUrl: '../vendor/gapi-service-bar/gapi-service-bar.html',
        controller: 'GapiServiceBarController',

        link: function (scope) {

            scope.openMenu = function ($mdOpenMenu, ev) {
                $mdOpenMenu(ev);
            };

        }
    };
}

angular.module('gapiServiceBar').directive('gapiServiceBar', [ '$mdDialog', GapiServiceBarDirective ]);
/*global angular, console, FormData, window*/
/*jslint todo: true */

(function () {
    "use strict";

    function GapiServiceBarFactory($http, $q, $window, $rootScope, core) {

        var factory = {

            validateUser: function () {

                // Creating Promise
                var tokenDefer = $q.defer(),
                    token;

                // Checking if it comes from accounts with querystring token
                if (window.location.search.split('=')[1]) {

                    // Will set token to SessionStorage
                    this.setToken(window.location.search.split('=')[1]);

                } else {

                    // If there's no token will redirect to accounts to get a new one
                    token = this.getToken();
                    if (!token) {
                        $window.location.href = this.getAccountsUrl() + '?callbackurl=' + window.location.href;
                        tokenDefer.reject();
                    }
                }

                // Validating Token against Core Server
                this.validateToken(function (err, validatedToken) {

                    if (err) {
                        tokenDefer.reject(err || 'No Data');
                    } else {

                        // Setting User Data
                        $window.localStorage.setItem('GAPI-USER', validatedToken.username);

                        // Setting User Applications
                        $window.localStorage.setItem('GAPI-APPS', []);

                        // Resolving Promise
                        tokenDefer.resolve();
                    }
                });

                return tokenDefer.promise;
            },

            validateToken: function (cb) {
                $http.get(core.getAccountsCoreUrl() + 'me')
                    .success(function (data) {
                        cb(null, data);
                    })
                    .error(function (err) {
                        console.log('[ERROR - validateToken]: ', err);
                        cb(err, null);
                    });
            },

            setToken: function (token) {
                if (token && token !== 'undefined' && token !== 'null') {
                    $window.localStorage.setItem('GAPI-TOKEN', token);
                }
            },

            getToken: function () {
                return $window.localStorage.getItem('GAPI-TOKEN');
            },

            logout: function () {

                $http.get(core.getAccountsCoreUrl() + 'accounts/logout/')
                    .success(function (data) {
                        // Remove User
                        $window.localStorage.removeItem('GAPI-USER');

                        // Remove Token
                        $window.sessionStorage.removeItem('GAPI-TOKEN');

                        // Remove Apps
                        $window.sessionStorage.removeItem('GAPI-APPS');

                        // Promise Resolve
                        $rootScope.$broadcast('GAPI-LOGOUT', data);
                    })
                    .error(function (err) {
                        // Promise Reject
                        $rootScope.$broadcast('GAPI-LOGOUT', err);
                    });

            },

            getUser: function () {
                var localGapiUser = $window.localStorage.getItem('GAPI-USER');
                return localGapiUser;
            },

            getCompanyName: function () {
                return 'Cliente';
            },

            getApplications: function () {
                //var localGapiApps = $window.localStorage.getItem('GAPI-APPS');
                return [{"name": "Integra"}];
            },

            getNotifications: function () {
                // TODO: Implement Websockets
                return [{"application": "Integra", "description": "Notificação de Teste", "timespan": "Agora pouco"}];
            },

            getMessages: function () {
                return [];
            },

            getCurrentApplication: function () {
                var currentApplication = core.getApplicationName();
                return currentApplication;
            },

            getAccountsUrl: function () {
                return core.getAccountsUrl();
            },

            redirect: function (url) {
                $window.location.href = url;
            }

        };

        return factory;

    }

    GapiServiceBarFactory.$inject = [ '$http', '$q', '$window', '$rootScope', 'coreApiService' ];

    angular.module('gapiServiceBar').factory('gapiServiceBarFactory', GapiServiceBarFactory);

}());

/*global angular, console*/
(function () {
    "use strict";

    function GapiServiceBarRequestInterceptor($q, $window) {

        return {

            // On request success
            request: function (config) {

                // Add Token info to every request
                config.headers.Authorization = $window.localStorage.getItem('GAPI-TOKEN');

                return config;
            },

            // On request error
            requestError: function (reason) {
                // Return the promise error reason.
                return $q.reject(reason);
            },

            // On response success
            response: function (response) {
                // Return the response or promise.
                return response || $q.when(response);
            },

            // On response error
            responseError: function (reason) {
                // Return the promise error reason.
                return $q.reject(reason);
            }

        };
    }

    GapiServiceBarRequestInterceptor.$inject = [ '$q', '$window' ];

    angular.module('gapiServiceBar').factory('gapiServiceBarRequestInterceptor', GapiServiceBarRequestInterceptor);

}());

//# sourceMappingURL=gapi-service-bar.min.js.map